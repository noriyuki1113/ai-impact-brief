<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="color-scheme" content="dark" />
  <meta name="description" content="AI Impact Brief ‚Äî Today's AI News (curated, calm, analytical)" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/logo.png" />

  <title>AI Impact Brief</title>

  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0b1220;
      --card:#101a2f;
      --card2:#0d1628;
      --text:#e9edf6;
      --muted:rgba(233,237,246,.72);
      --muted2:rgba(233,237,246,.55);
      --line:rgba(255,255,255,.10);
      --accent:#6fa7ff;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius:22px;
      --radius2:18px;
      --maxw: 720px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
        "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 50% -10%, rgba(111,167,255,.18), transparent 60%),
        radial-gradient(900px 900px at 20% 20%, rgba(120,255,210,.10), transparent 65%),
        radial-gradient(900px 900px at 90% 40%, rgba(255,120,170,.10), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 22px 16px 40px;
    }

    .wrap{max-width:var(--maxw); margin:0 auto;}
    .top{
      display:flex;
      align-items:flex-start;
      gap:14px;
      padding: 6px 2px 18px;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
    }
    .logo img{
      width:100%;height:100%;object-fit:cover; /* Â∞è„Åï„ÅèË¶ã„Åà„Å™„ÅÑ„Çà„ÅÜ„Å´ */
      display:block;
    }
    .brand{
      flex:1;
      min-width:0;
    }
    .brand h1{
      margin:0;
      font-size:24px;
      letter-spacing:.01em;
      line-height:1.15;
    }
    .brand .sub{
      margin-top:4px;
      color:var(--muted2);
      font-size:13px;
      letter-spacing:.02em;
    }
    .date{
      margin-top:10px;
      color:rgba(233,237,246,.62);
      font-size:12px;
      letter-spacing:.03em;
    }

    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin: 4px 0 16px;
    }
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      font-weight:700;
      letter-spacing:.02em;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: rgba(111,167,255,.18);
      border-color: rgba(111,167,255,.28);
    }

    .status{
      margin-left:auto;
      font-size:12px;
      color:var(--muted2);
      display:flex;align-items:center;gap:8px;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .dot.ok{background: rgba(83,226,140,.95); box-shadow: 0 0 0 4px rgba(83,226,140,.12);}
    .dot.bad{background: rgba(255,95,95,.95); box-shadow: 0 0 0 4px rgba(255,95,95,.12);}

    .cards{display:flex; flex-direction:column; gap:14px;}

    .card{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 200px at 30% 0%, rgba(111,167,255,.18), transparent 60%);
      pointer-events:none;
      opacity:.6;
    }
    .card > *{position:relative}

    .headrow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    /* ===== Badge: strong contrast ===== */
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.04em;
      line-height:1;
      color:#0b1220;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.35);
      box-shadow:0 12px 28px rgba(0,0,0,.25);
      text-transform:uppercase;
      user-select:none;
      min-width:70px;
    }
    .badge[data-level="High"]{
      background:linear-gradient(180deg, rgba(255,95,95,.98), rgba(255,95,95,.78));
      color:#0b1220;
      border-color:rgba(255,95,95,.35);
    }
    .badge[data-level="Medium"]{
      background:linear-gradient(180deg, rgba(255,199,63,.98), rgba(255,199,63,.78));
      color:#0b1220;
      border-color:rgba(255,199,63,.35);
    }
    .badge[data-level="Low"]{
      background:linear-gradient(180deg, rgba(83,226,140,.98), rgba(83,226,140,.78));
      color:#0b1220;
      border-color:rgba(83,226,140,.35);
    }

    .title{
      margin: 6px 0 10px;
      font-size:18px;
      letter-spacing:.01em;
      line-height:1.28;
    }
    .one{
      margin: 0 0 14px;
      color: rgba(233,237,246,.88);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 12px 12px;
      border-radius: 16px;
      font-size:13px;
      line-height:1.55;
    }

    /* ===== Sections ===== */
    .section{
      margin-top: 12px;
    }
    .section-title{
      margin: 0 0 8px;
      font-size:13px;
      font-weight:900;
      letter-spacing:.06em;
      color:rgba(233,237,246,.92);
      display:flex; align-items:center;
      gap:8px;
    }
    .section-title::before{
      content:"";
      width:10px;height:10px;border-radius:3px;
      background: rgba(111,167,255,.95);
      box-shadow: 0 10px 26px rgba(111,167,255,.22);
    }
    .bullets{
      margin:0;
      padding-left: 16px;
      color: rgba(233,237,246,.86);
      font-size:13px;
      line-height:1.6;
    }
    .bullets li{margin:6px 0}

    .actions{
      margin-top: 14px;
      display:flex;
      justify-content:flex-start;
      gap:10px;
    }
    .linkbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 11px 14px;
      border-radius: 14px;
      text-decoration:none;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
      color:#0b1220;
      background: linear-gradient(180deg, rgba(111,167,255,.98), rgba(111,167,255,.80));
      border:1px solid rgba(111,167,255,.35);
      box-shadow: 0 16px 40px rgba(111,167,255,.18);
    }

    /* Loading skeleton */
    .skeleton{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      height: 140px;
      overflow:hidden;
      position:relative;
      box-shadow: var(--shadow);
    }
    .skeleton::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      100%{transform: translateX(100%)}
    }

    .errorbox{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,95,95,.10);
      border: 1px solid rgba(255,95,95,.22);
      color: rgba(233,237,246,.92);
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    footer{
      margin-top: 20px;
      color: rgba(233,237,246,.45);
      font-size: 12px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <div class="logo" aria-label="AI Impact Brief Logo">
        <!-- „É≠„Ç¥„Éï„Ç°„Ç§„É´ÂêçÔºölogo.png „ÇíÊé®Â•®„ÄÇ„ÅÇ„Å™„Åü„ÅåGitHub„ÅßÂêçÂâçÂ§âÊõ¥„Åó„Åü„Å™„Çâ„Åì„Åì„ÇÇÂêà„Çè„Åõ„Çã -->
        <img src="/6E18786B-123B-4ADC-A30E-EC7D5A01A4FE.png" alt="AI Impact Brief" /> alt="AI Impact Brief" />
      </div>
      <div class="brand">
        <h1>AI Impact Brief</h1>
        <div class="sub">Today's AI News</div>
        <div class="date" id="dateLine">‚Äî</div>
      </div>
    </header>

    <div class="toolbar">
      <button class="btn primary" id="reloadBtn">‚Üª Êõ¥Êñ∞</button>
      <button class="btn" id="clearCacheBtn">üßπ „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞</button>
      <div class="status" id="statusLine"><span class="dot" id="statusDot"></span><span id="statusText">Ê∫ñÂÇô‰∏≠</span></div>
    </div>

    <main id="content">
      <div class="cards" id="cards">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
      <div id="error" class="errorbox" style="display:none;"></div>
    </main>

    <footer>Independent ‚Ä¢ Not affiliated with any publisher.</footer>
  </div>

  <script>
    // ===== Config =====
    const API_PATH = "/api/today";         // Vercel„ÅÆAPI
    const FORCE_BUST_PARAM = "v";          // cache-bust param name

    // ===== Utilities =====
    const $ = (s) => document.querySelector(s);
    function setStatus(ok, text){
      $("#statusText").textContent = text;
      $("#statusDot").classList.toggle("ok", !!ok);
      $("#statusDot").classList.toggle("bad", ok === false);
    }

    function toJapaneseDateLine(dateObj){
      // Friday, February 13, 2026 „ÅÆËã±Ë™û„Çí„ÇÑ„ÇÅ„Å¶„Äå2026Âπ¥2Êúà13Êó•ÔºàÈáëÔºâ„Äç„Å´
      const y = dateObj.getFullYear();
      const m = dateObj.getMonth()+1;
      const d = dateObj.getDate();
      const wd = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"][dateObj.getDay()];
      return `${y}Âπ¥${m}Êúà${d}Êó•Ôºà${wd}Ôºâ`;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeLevel(level){
      const s = String(level||"").toLowerCase();
      if(s.includes("high")) return "High";
      if(s.includes("medium")) return "Medium";
      if(s.includes("low")) return "Low";
      return "Medium";
    }

    // Ë¶ãÂá∫„Åó„Çí ‚Äú‰∏äË≥™‚Äù „Å´Áµ±‰∏ÄÔºà„ÅÇ„Å™„Åü„ÅÆË¶ÅÊúõÔºâ
    const LABELS = {
      fact_summary: "‰∫ãÂÆüÊï¥ÁêÜ",
      implications: "ÊÑèÂë≥„Åô„Çã„ÇÇ„ÅÆ",
      outlook: "‰ªäÂæå„ÅÆÁÑ¶ÁÇπ",
    };

    function renderItem(item){
      const level = normalizeLevel(item.impact_level);
      const title = escapeHtml(item.title_ja || "");
      const one = escapeHtml(item.one_sentence || "");
      const url = item.original_url || item.originalUrl || item.originalUrl || "#";

      const fact = Array.isArray(item.fact_summary) ? item.fact_summary : [];
      const impl = Array.isArray(item.implications) ? item.implications : [];
      const outl = Array.isArray(item.outlook) ? item.outlook : [];

      const bullets = (arr)=> arr.slice(0,4).map(x=>`<li>${escapeHtml(x)}</li>`).join("");

      return `
        <article class="card">
          <div class="headrow">
            <span class="badge" data-level="${level}">${level}</span>
          </div>

          <h2 class="title">${title}</h2>
          <div class="one">${one}</div>

          <section class="section">
            <h3 class="section-title">${LABELS.fact_summary}</h3>
            <ul class="bullets">${bullets(fact)}</ul>
          </section>

          <section class="section">
            <h3 class="section-title">${LABELS.implications}</h3>
            <ul class="bullets">${bullets(impl)}</ul>
          </section>

          <section class="section">
            <h3 class="section-title">${LABELS.outlook}</h3>
            <ul class="bullets">${bullets(outl)}</ul>
          </section>

          <div class="actions">
            <a class="linkbtn" href="${escapeHtml(url)}" target="_blank" rel="noreferrer">ÂÖÉË®ò‰∫ã„ÇíË™≠„ÇÄ</a>
          </div>
        </article>
      `;
    }

    function showError(msg){
      const el = $("#error");
      el.style.display = "block";
      el.textContent = msg;
      setStatus(false, "ÂèñÂæó„Å´Â§±Êïó");
    }
    function hideError(){
      $("#error").style.display = "none";
      $("#error").textContent = "";
    }

    function setSkeleton(){
      $("#cards").innerHTML = `
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      `;
    }

    // ===== Fetch =====
    async function fetchBrief({bust=false} = {}){
      hideError();
      setStatus(null, "ÂèñÂæó‰∏≠‚Ä¶");
      setSkeleton();

      const now = new Date();
      $("#dateLine").textContent = toJapaneseDateLine(now);

      // cache bustÔºàPWA/ServiceWorker„ÅåÂº∑„ÅÑ„ÅÆ„ÅßÔºâ
      const url = new URL(API_PATH, location.origin);
      if(bust){
        url.searchParams.set(FORCE_BUST_PARAM, String(Date.now()));
      }

      try{
        const res = await fetch(url.toString(), {
          method: "GET",
          cache: "no-store",
          headers: { "Accept": "application/json" }
        });

        const text = await res.text();
        if(!res.ok){
          showError(`API Error: ${res.status} ${res.statusText}\n\n${text.slice(0,1200)}`);
          return;
        }

        let data;
        try{
          data = JSON.parse(text);
        }catch(e){
          showError(`JSON Parse Error\n\n${text.slice(0,1200)}`);
          return;
        }

        const items = Array.isArray(data.items) ? data.items : [];
        if(items.length === 0){
          showError("No items returned from API.");
          return;
        }

        // 3‰ª∂„Å†„ÅëË°®Á§∫ÔºàAPI„ÅØ3‰ª∂ÊÉ≥ÂÆöÔºâ
        const html = items.slice(0,3).map(renderItem).join("");
        $("#cards").innerHTML = html;

        setStatus(true, "ÊúÄÊñ∞„ÇíË°®Á§∫‰∏≠");
      }catch(e){
        showError(`Network Error: ${e?.message || String(e)}\n(Check CORS, network connection, or URL)`);
      }
    }

    // ===== PWA Service Worker =====
    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      try{
        // sw.js „ÅØÂêå„É™„Éù„Ç∏„Éà„É™Áõ¥‰∏ã„Å´ÁΩÆ„ÅèÊÉ≥ÂÆöÔºà„Å™„Åë„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„ÅôÔºâ
        const reg = await navigator.serviceWorker.register("/sw.js");
        // Êõ¥Êñ∞„Åå„ÅÇ„Çå„Å∞Âç≥ÂèçÊò†„Åï„Åõ„ÇÑ„Åô„Åè
        reg.update().catch(()=>{});
      }catch(e){
        // SW„ÅåÁÑ°„ÅÑÂ†¥Âêà„Å™„Å©„ÅØÁÑ°Ë¶ñ
      }
    }

    // ===== Cache refresh button =====
    async function hardRefresh(){
      // SW„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞ÊåáÁ§∫ ‚Üí „É™„É≠„Éº„Éâ
      try{
        const regs = await navigator.serviceWorker.getRegistrations();
        for(const r of regs){
          await r.update().catch(()=>{});
        }
      }catch(e){}
      await fetchBrief({bust:true});
    }

    // ===== init =====
    $("#reloadBtn").addEventListener("click", ()=>fetchBrief({bust:true}));
    $("#clearCacheBtn").addEventListener("click", ()=>hardRefresh());

    registerSW();
    fetchBrief({bust:false});
  </script>
</body>
</html>
